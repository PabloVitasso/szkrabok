From a165dd98274c3632b15fe8e93063a92da597df29 Mon Sep 17 00:00:00 2001
From: My Name <myemail@example.com>
Date: Sun, 8 Feb 2026 19:41:56 +0100
Subject: [PATCH] Add core files

---
 core/pool.js    | 31 +++++++++++++++++++++++++
 core/stealth.js | 41 +++++++++++++++++++++++++++++++++
 core/storage.js | 61 +++++++++++++++++++++++++++++++++++++++++++++++++
 3 files changed, 133 insertions(+)
 create mode 100644 core/pool.js
 create mode 100644 core/stealth.js
 create mode 100644 core/storage.js

diff --git a/core/pool.js b/core/pool.js
new file mode 100644
index 0000000..c0b05e8
--- /dev/null
+++ b/core/pool.js
@@ -0,0 +1,31 @@
+import { SessionNotFoundError } from '../utils/errors.js'
+
+const sessions = new Map()
+
+export const add = (id, context, page) => {
+  sessions.set(id, { context, page, createdAt: Date.now() })
+}
+
+export const get = id => {
+  const session = sessions.get(id)
+  if (!session) throw new SessionNotFoundError(id)
+  return session
+}
+
+export const has = id => sessions.has(id)
+
+export const remove = id => {
+  sessions.delete(id)
+}
+
+export const list = () =>
+  Array.from(sessions.entries()).map(([id, session]) => ({
+    id,
+    createdAt: session.createdAt,
+  }))
+
+export const closeAllSessions = async () => {
+  const promises = Array.from(sessions.values()).map(s => s.context.close())
+  await Promise.allSettled(promises)
+  sessions.clear()
+}
\ No newline at end of file
diff --git a/core/stealth.js b/core/stealth.js
new file mode 100644
index 0000000..130f1c3
--- /dev/null
+++ b/core/stealth.js
@@ -0,0 +1,41 @@
+import { addExtra } from 'playwright-extra'
+import StealthPlugin from 'puppeteer-extra-plugin-stealth'
+import { log } from '../utils/logger.js'
+
+let stealthInitialized = false
+
+export const enhanceWithStealth = browser => {
+  if (!stealthInitialized) {
+    log('Initializing stealth plugin')
+    stealthInitialized = true
+  }
+
+  try {
+    const enhanced = addExtra(browser)
+    const stealth = StealthPlugin()
+
+    // Disable conflicting evasions
+    stealth.enabledEvasions.delete('user-data-dir')
+
+    // Enable all other evasions explicitly
+    stealth.enabledEvasions.add('chrome.app')
+    stealth.enabledEvasions.add('chrome.csi')
+    stealth.enabledEvasions.add('chrome.loadTimes')
+    stealth.enabledEvasions.add('chrome.runtime')
+    stealth.enabledEvasions.add('iframe.contentWindow')
+    stealth.enabledEvasions.add('media.codecs')
+    stealth.enabledEvasions.add('navigator.hardwareConcurrency')
+    stealth.enabledEvasions.add('navigator.languages')
+    stealth.enabledEvasions.add('navigator.permissions')
+    stealth.enabledEvasions.add('navigator.plugins')
+    stealth.enabledEvasions.add('navigator.vendor')
+    stealth.enabledEvasions.add('navigator.webdriver')
+    stealth.enabledEvasions.add('window.outerdimensions')
+
+    enhanced.use(stealth)
+    return enhanced
+  } catch (err) {
+    log('Stealth plugin failed, using vanilla Playwright', err.message)
+    return browser
+  }
+}
\ No newline at end of file
diff --git a/core/storage.js b/core/storage.js
new file mode 100644
index 0000000..0b5d3ae
--- /dev/null
+++ b/core/storage.js
@@ -0,0 +1,61 @@
+import { readFile, writeFile, mkdir, rm, readdir } from 'fs/promises'
+import { join } from 'path'
+import { existsSync } from 'fs'
+
+const SESSIONS_DIR = './sessions'
+
+const getSessionDir = id => join(SESSIONS_DIR, id)
+const getStatePath = id => join(getSessionDir(id), 'state.json')
+const getMetaPath = id => join(getSessionDir(id), 'meta.json')
+
+export const ensureSessionsDir = async () => {
+  if (!existsSync(SESSIONS_DIR)) {
+    await mkdir(SESSIONS_DIR, { recursive: true })
+  }
+}
+
+export const sessionExists = id => existsSync(getSessionDir(id))
+
+export const loadState = async id => {
+  const path = getStatePath(id)
+  if (!existsSync(path)) return null
+  const data = await readFile(path, 'utf-8')
+  return JSON.parse(data)
+}
+
+export const saveState = async (id, state) => {
+  await mkdir(getSessionDir(id), { recursive: true })
+  await writeFile(getStatePath(id), JSON.stringify(state, null, 2))
+}
+
+export const loadMeta = async id => {
+  const path = getMetaPath(id)
+  if (!existsSync(path)) return null
+  const data = await readFile(path, 'utf-8')
+  return JSON.parse(data)
+}
+
+export const saveMeta = async (id, meta) => {
+  await mkdir(getSessionDir(id), { recursive: true })
+  await writeFile(getMetaPath(id), JSON.stringify(meta, null, 2))
+}
+
+export const updateMeta = async (id, updates) => {
+  const meta = (await loadMeta(id)) || {}
+  const updated = { ...meta, ...updates, lastUsed: Date.now() }
+  await saveMeta(id, updated)
+  return updated
+}
+
+export const deleteSession = async id => {
+  const dir = getSessionDir(id)
+  if (existsSync(dir)) {
+    await rm(dir, { recursive: true })
+  }
+}
+
+export const listSessions = async () => {
+  await ensureSessionsDir()
+  const dirs = await readdir(SESSIONS_DIR, { withFileTypes: true })
+  return dirs.filter(d => d.isDirectory()).map(d => d.name)
+}
\ No newline at end of file
-- 
2.43.0

