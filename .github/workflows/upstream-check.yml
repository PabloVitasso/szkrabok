name: Upstream check

on:
  schedule:
    - cron: '0 9 * * 1'  # every Monday at 09:00 UTC
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Check upstream difference
        id: compare
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          BASE_BRANCH="${{ github.ref_name }}"

          UPSTREAM_OWNER="microsoft"
          UPSTREAM_REPO="playwright-mcp"
          UPSTREAM_BRANCH="main"

          UPSTREAM_SHA=$(curl -s \
            https://api.github.com/repos/$UPSTREAM_OWNER/$UPSTREAM_REPO/branches/$UPSTREAM_BRANCH \
            | jq -r '.commit.sha')

          RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$OWNER/$REPO/compare/$BASE_BRANCH...$UPSTREAM_SHA)

          BEHIND=$(echo "$RESPONSE" | jq -r '.behind_by')

          echo "behind=$BEHIND" >> "$GITHUB_OUTPUT"

      - name: Open issue if behind
        if: steps.compare.outputs.behind != '0'
        run: |
          COUNT="${{ steps.compare.outputs.behind }}"
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"

          EXISTING=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$OWNER/$REPO/issues?state=open&labels=upstream-sync" \
            | jq 'length')

          if [ "$EXISTING" -gt 0 ]; then
            echo "Issue already open, skipping."
            exit 0
          fi

          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$OWNER/$REPO/issues \
            -d @- <<EOF
          {
            "title": "Upstream sync needed: $COUNT new commit(s) in microsoft/playwright-mcp",
            "body": "\`upstream/main\` has $COUNT new commit(s) not yet merged.\n\n**To merge:**\n\`\`\`bash\ngit fetch upstream\ngit checkout -b merge-upstream-playwright-mcp\ngit merge upstream/main\n\`\`\`\n\nSee [docs/development.md](docs/development.md) for conflict resolution guidance.",
            "labels": ["upstream-sync"]
          }
EOF
