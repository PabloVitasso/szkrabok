# szkrabok.config.toml
#
# Browser identity, viewport, and locale configuration for szkrabok.
#
# ── How this file is used ─────────────────────────────────────────────────────
#
#   MCP session launch:
#     Loaded by src/config.js at server startup.
#     session.open applies [default] unless a preset is requested:
#       session.open { "sessionName": "x", "launchOptions": { "preset": "mobile-iphone-15" } }
#     The resolved config (all effective values) is returned in the response.
#
#   Playwright standalone runs:
#     Loaded by playwright.config.ts.
#     Set SZKRABOK_PRESET=<name> to select a preset (defaults to "default").
#     The resolved preset is printed to console at test start via globalSetup.
#
# ── Merge behaviour ───────────────────────────────────────────────────────────
#
#   Presets are sparse — they only need to override what differs from [default].
#   Anything not set in a preset is inherited from [default].
#   Merge order: [default] → [preset.<name>]
#
# ── Override hierarchy (highest wins) ────────────────────────────────────────
#
#   1. session.open config.* fields (per-call, MCP only)
#   2. SZKRABOK_PRESET env var (selects preset for Playwright standalone)
#   3. [preset.<name>] values
#   4. [default] values
#   5. Hardcoded fallbacks in src/config.js
#
# ── Stealth ───────────────────────────────────────────────────────────────────
#
#   Stealth (playwright-extra + puppeteer-extra-plugin-stealth) is a separate
#   concern from browser identity. It is configured in [stealth] and applies
#   independently of which preset is selected.
#   Toggle per-session: session.open { "launchOptions": { "stealth": false } }
#
# ─────────────────────────────────────────────────────────────────────────────

# ── Default ───────────────────────────────────────────────────────────────────
#
# Applied when no preset is specified. Represents a typical desktop Chrome
# session on Windows — the most common and least suspicious fingerprint.

[default]
# Human-readable label shown in session.open response, session.list, and
# Playwright console output. Set to any string that helps you identify this config.
label             = "Desktop Chrome / Windows 10"
overrideUserAgent = false
# userAgent = "..."   # set in szkrabok.config.local.toml or pick a preset
# BCP 47 language tag — affects Accept-Language header and navigator.language
locale    = "en-US"
# IANA timezone — affects Date, Intl, and timezone detection fingerprints
timezone  = "America/New_York"
# false = headed (visible window). Set HEADLESS=true env var for CI.
# Presets do not override headless — it is an environment decision, not an identity.
headless        = false
# executablePath = "..."  # set in szkrabok.config.local.toml (run: bash scripts/detect_browsers.sh)
# Default timeout in milliseconds for Playwright operations
timeout     = 30000
# Disable WebGL to reduce fingerprinting surface
disable_webgl = true
# Log verbosity: error, warn, info, debug — or "none"/unset to disable entirely.
# Default is "none": no logs written, no /tmp files created (privacy).
# Override in szkrabok.config.local.toml to enable on a specific machine.
# When enabled, logs go to e.g. /tmp/202602242135szkrabok-mcp.log
log_level   = "none"

[default.viewport]
# Standard 16:10 laptop resolution
width  = 1280
height = 800

# ── puppeteer-extra-plugin-stealth ────────────────────────────────────────────
#
# All settings in this section map 1:1 to the npm package:
#   puppeteer-extra-plugin-stealth
#   https://github.com/berstend/puppeteer-extra/tree/master/packages/puppeteer-extra-plugin-stealth
#
# Each evasion is a sub-plugin that patches a specific browser API to hide
# headless/automation signals. Evasion names below are the exact strings used
# by the plugin — they can be copy-pasted into enabledEvasions.add/delete calls.
#
# Per-session override (MCP only):
#   session.open { "launchOptions": { "stealth": false } }  — disables all evasions

[puppeteer-extra-plugin-stealth]
# Master switch. When false, no evasions are applied at all and the browser
# runs as vanilla headless Chromium — easily detectable.
enabled = true

# ── Headless Chrome API mocks ─────────────────────────────────────────────────
# These fix APIs that are absent or behave incorrectly in headless Chromium.
# Disabling any of them makes standard headless detection trivial.
# None of these have configurable options — enabled/disabled only.

[puppeteer-extra-plugin-stealth.evasions]
# chrome.app          — mocks window.chrome.app (missing in headless)
# chrome.csi          — mocks window.chrome.csi() timing function (missing in headless)
# chrome.loadTimes    — mocks window.chrome.loadTimes() (missing in headless)
# chrome.runtime      — mocks window.chrome.runtime on secure pages (missing in headless)
# defaultArgs         — removes automation-specific Chromium launch arguments
#                       e.g. --enable-automation, --disable-background-networking
# iframe.contentWindow — fixes HEADCHR_IFRAME: iframe.contentWindow.chrome detection
# media.codecs        — makes Chromium report correct codec support (broken in headless)
# navigator.permissions — fixes Notification.permission inconsistency in headless
# navigator.plugins   — populates navigator.plugins + navigator.mimeTypes (empty in headless)
# navigator.webdriver — removes navigator.webdriver = true (most basic automation signal)
# sourceurl           — strips sourceURL comments injected by puppeteer into eval'd scripts
# window.outerdimensions — sets window.outerWidth / window.outerHeight (missing in headless)
"chrome.app"             = true
"chrome.csi"             = true
"chrome.loadTimes"       = true
"chrome.runtime"         = true
"defaultArgs"            = true
"iframe.contentWindow"   = true
"media.codecs"           = true
"navigator.permissions"  = true
"navigator.plugins"      = true
"navigator.webdriver"    = true
"sourceurl"              = true
"window.outerdimensions" = true
# user-data-dir: PERMANENTLY DISABLED in szkrabok.
# This evasion conflicts with persistent session profiles (sessions/{id}/profile/).
# szkrabok manages user data directories directly — do not add this evasion.

# ── user-agent-override ───────────────────────────────────────────────────────
# The most important evasion. Applies the full browser identity bundle
# consistently via CDP Network.setUserAgentOverride on every new page:
#   - navigator.userAgent            (the UA string)
#   - navigator.userAgentData        (brands, platform, version, architecture)
#   - navigator.platform             (Win32, MacIntel, Linux, etc.)
#   - Accept-Language request header
# All four are kept in sync — eliminates the most common detection vector
# (contradictory userAgent vs userAgentData signals).
#
# user_agent and locale are NOT set here — they are taken automatically from
# the active preset ([default] or named preset). Set them in the preset to
# control the spoofed identity.
#
# When enabled = false: browser reports its real Chromium UA and Linux platform.
# HeadlessChrome is not stripped. Consistent, but trivially detectable as headless.

[puppeteer-extra-plugin-stealth."user-agent-override"]
enabled    = true
# mask_linux: when true, rewrites the Linux platform token in the UA string to
# "Windows NT 10.0; Win64; x64" even when no explicit userAgent is configured.
# Prevents the "running on Linux = headless bot" signal.
# Set to false only if you intentionally want to report Linux (e.g. server UA).
mask_linux = true

# ── navigator.vendor ─────────────────────────────────────────────────────────
# Sets navigator.vendor. In headless Chromium the default is an empty string,
# which is a well-known bot signal. Real Chrome reports "Google Inc.".
# Change only when spoofing a non-Chrome UA (e.g. Safari → "Apple Computer, Inc.").

[puppeteer-extra-plugin-stealth."navigator.vendor"]
enabled = true
vendor  = "Google Inc."

# ── navigator.hardwareConcurrency ─────────────────────────────────────────────
# Sets navigator.hardwareConcurrency (number of logical CPU cores).
# Headless Chromium reports 2 by default, which is suspicious for a "desktop
# browser". Common real values: 4 (laptop), 8 (desktop), 16 (workstation).

[puppeteer-extra-plugin-stealth."navigator.hardwareConcurrency"]
enabled              = true
hardware_concurrency = 4

# ── navigator.languages ───────────────────────────────────────────────────────
# Sets navigator.languages array and the Accept-Language header.
# Derived automatically from the active preset locale — no override needed
# unless you want navigator.languages to differ from the preset locale.
# Example override: languages = ["en-GB", "en"]

[puppeteer-extra-plugin-stealth."navigator.languages"]
enabled = true
# languages = []  # leave empty to derive from active preset locale

# ── webgl.vendor ──────────────────────────────────────────────────────────────
# Overrides the WebGL VENDOR and RENDERER strings reported by the GPU.
# Headless defaults are "Google Inc." / "Google SwiftShader" — well-known
# bot fingerprints. Use values matching the UA's implied hardware.
# Common alternatives:
#   vendor   = "NVIDIA Corporation"  renderer = "NVIDIA GeForce GTX 1080/PCIe/SSE2"
#   vendor   = "ATI Technologies"    renderer = "AMD Radeon RX 580"

[puppeteer-extra-plugin-stealth."webgl.vendor"]
enabled  = true
vendor   = "Intel Inc."
renderer = "Intel Iris OpenGL Engine"

# ── Honest Chromium preset ────────────────────────────────────────────────────
#
# Does not spoof the UA string. Both navigator.userAgent and navigator.userAgentData
# report the actual Chromium binary version consistently.
# The useragent check on bot-detector.rebrowser.net will still fail (no Google Chrome
# brand), but there are no contradictory signals between the two UA APIs.

[preset.chromium-honest]
# No userAgent set — stealth user-agent-override evasion strips HeadlessChrome
# but does not spoof platform. Consistent signals, no Windows masking.
label = "Chromium (no UA spoof)"

[preset.chromium-honest.viewport]
width  = 1280
height = 800

# ── Desktop presets ───────────────────────────────────────────────────────────

[preset.desktop-chrome-win]
label     = "Desktop / Windows 10 / Chrome 120"
userAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"

[preset.desktop-chrome-win.viewport]
width  = 1280
height = 800

[preset.desktop-chrome-mac]
label     = "Desktop / macOS Ventura / Chrome 120"
# macOS Ventura — common developer machine fingerprint
userAgent = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"

[preset.desktop-chrome-mac.viewport]
# Standard MacBook Pro resolution
width  = 1440
height = 900

[preset.desktop-firefox-win]
label     = "Desktop / Windows 10 / Firefox 121"
# Gecko UA — distinct from the Chrome family, useful for testing Firefox-specific behaviour
userAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0"

[preset.desktop-firefox-win.viewport]
width  = 1280
height = 800

[preset.desktop-safari-mac]
label     = "Desktop / macOS Sonoma / Safari 17"
# WebKit UA — note: Playwright always runs Chromium; only the UA string and
# viewport change. Use for sites that serve different content to Safari.
userAgent = "Mozilla/5.0 (Macintosh; Intel Mac OS X 14_2_1) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2 Safari/605.1.15"

[preset.desktop-safari-mac.viewport]
width  = 1440
height = 900

# ── Mobile presets ────────────────────────────────────────────────────────────

[preset.mobile-iphone-15]
label     = "Mobile / iPhone 15 / iOS 17 / Safari"
# Mobile Safari on iPhone 15, iOS 17.2
userAgent = "Mozilla/5.0 (iPhone; CPU iPhone OS 17_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2 Mobile/15E148 Safari/604.1"
locale    = "en-US"
timezone  = "America/New_York"

[preset.mobile-iphone-15.viewport]
# iPhone 15 logical resolution (3× DPR device, reported as CSS pixels)
width  = 393
height = 852

[preset.mobile-android-chrome]
label     = "Mobile / Pixel 8 / Android 14 / Chrome 120"
# Chrome 120 on Pixel 8, Android 14
userAgent = "Mozilla/5.0 (Linux; Android 14; Pixel 8) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.144 Mobile Safari/537.36"

[preset.mobile-android-chrome.viewport]
# Pixel 8 logical resolution
width  = 412
height = 915

# ── Tablet presets ────────────────────────────────────────────────────────────

[preset.tablet-ipad-pro]
label     = "Tablet / iPad Pro 12.9\" / iPadOS 17 / Safari"
# Safari on iPad Pro 12.9", iPadOS 17.2
userAgent = "Mozilla/5.0 (iPad; CPU OS 17_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2 Mobile/15E148 Safari/604.1"

[preset.tablet-ipad-pro.viewport]
# iPad Pro 12.9" logical resolution (landscape)
width  = 1366
height = 1024
